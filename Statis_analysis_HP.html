<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Statistic Analysis</title>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div id="myChart" style="width: 600px;height:400px;"></div>
<input type="button" style="background-color: grey;" value="change" id="changeButton" onclick="changeStyle()">

<script>
    const geojsonURLNewhame = 'https://raw.githubusercontent.com/X-Fan-Jack/tube-empower-london-regeneration/jack/data/msoa_geojson_NH_data.geojson';
    var chartStyle = 'Map';
    var datafilter = 'HP_mean_change_2002_2012';  
    var mapOption, barOption;
    var dataMax, dataMin;
    var data_Newham;
    const data_json = {
        "type": "FeatureCollection",
        "features": []
    };

    dataMax = 3.01;
    dataMin = 1.412;

    var myChart = echarts.init(document.getElementById('myChart'));

    myChart.showLoading();


    var xhr = new XMLHttpRequest();
    xhr.open('GET', geojsonURLNewhame);
    xhr.send();
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
            data_Newham = JSON.parse(xhr.responseText);

            for (const feature of data_Newham.features) {
                data_json.features.push({
                    "type": "Feature",
                    "properties": Object.assign(
                        feature.properties, {name: feature.properties.MSOA_NAME}
                    ),
                    "geometry": feature.geometry
                });
            }

            echarts.registerMap('Newham', {geoJSON: data_json});

            var data = filterDataByField(datafilter, data_json);
            data.sort(function (a, b) {
                return a.value - b.value;
            });


            mapOption = {
                title: {
                    text: 'Change in Mean House Price Growth Rate(2002-2012)',
                    subtext: 'Data from www.ons.gov.uk',
                    sublink: 'https://www.ons.gov.uk/peoplepopulationandcommunity/housing/datasets/hpssadataset2medianhousepricebymsoaquarterlyrollingyear',
                    left: 'right'
                },
                geo: [{
                    map: 'Newham',
                }],
                visualMap: {
                    left: 'right',
                    min: dataMin,
                    max: dataMax,
                    precision: 10,
                    inRange: {
                        color: ['#313695',
                            '#4575b4',
                            '#e0f3f8',
                            '#ffffbf',
                            '#fee090',
                            '#d73027',
                            '#a50026']
                    },
                    text: ['High', 'Low'],
                    calculable: true
                },
                toolbox: {
                    show: true,
                    left: 'left',
                    top: 'top',
                    feature: {
                        dataView: {readOnly: false},
                        restore: {},
                        saveAsImage: {}
                    }
                },
                tooltip: {
                    trigger: 'item',
                    showDelay: 0,
                    transitionDuration: 0.2
                },
                series: [
                    {
                        name: 'MSOA_CODE ' + datafilter,
                        type: 'map',
                        map: 'Newham',
                        animationDurationUpdate: 500,
                        universalTransition: true,
                        emphasis: {
                            label: {
                                show: true
                            }
                        },
                        data: data,
                    }
                ]
            };

            barOption = {
                xAxis: {
                    type: 'value'
                },
                yAxis: {
                    type: 'category',

                    axisLabel: {
                        rotate: 30,
                        textStyle: {
                            fontSize: 8, 
                        }
                    },
                    data: data.map(function (item) {
                        return item.name;
                    })
                },
                animationDurationUpdate: 500,
                series: {
                    type: 'bar',
                    id: 'bar',
                    data: data.map(function (item) {
                        return item.value;
                    }),
                    universalTransition: true
                }
            };

            loadChart();

            myChart.hideLoading();
        }
    };


    function filterDataByField(datafilter, data_js) {
        var filterField = datafilter.trim();

        var filteredFeatures = data_js.features.map(feature => {
            const {properties} = feature;
            return {name: properties.MSOA_NAME, value: properties[filterField]};
        });

        return filteredFeatures;
    }

    function changeStyle() {
        if (chartStyle === 'Map') {
            chartStyle = 'Bar';
        } else if (chartStyle === 'Bar') {
            chartStyle = 'Map';
        }
        loadChart();
    };

    function loadChart() {
        if (chartStyle === 'Map') {
            myChart.setOption(mapOption, true);
        } else if (chartStyle === 'Bar') {
            myChart.setOption(barOption, true);
        }
    }


</script>
</body>
</html>